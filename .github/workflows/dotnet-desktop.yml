name: Build and Release Amaurot Quest Editor
permissions:
  contents: write

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug]

    runs-on: windows-latest

    env:
      Solution_Name: "map editor.sln"                     
      Project_Path: Amaurot.csproj                         

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive       
             
    - name: Initialize and fix submodules
      run: |
        Write-Host "üîß Initializing submodules..."
        git submodule update --init --recursive
        
        Write-Host "üîß Checking LGB-Parser submodule..."
        if (Test-Path "./LGB-Parser") {
          cd LGB-Parser
          git fetch origin
          git checkout main
          git pull origin main
          cd ..
          Write-Host "‚úÖ LGB-Parser submodule updated"
        } else {
          Write-Host "‚ö†Ô∏è LGB-Parser submodule not found"
        }
        
        Write-Host "üîß Checking unluac submodule..."
        if (Test-Path "./unluac") {
          cd unluac
          git fetch origin
          git checkout master
          git pull origin master
          cd ..
          Write-Host "‚úÖ unluac submodule updated"
        } else {
          Write-Host "‚ö†Ô∏è unluac submodule not found"
        }

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
      
    - name: Restore main solution dependencies
      run: dotnet restore "$env:Solution_Name"
       
    - name: Restore LGB-Parser dependencies
      run: |
        if (Test-Path "./LGB-Parser/LGB-Parser.csproj") {
          Write-Host "üîß Restoring LGB-Parser dependencies..."
          dotnet restore "./LGB-Parser/LGB-Parser.csproj"
          Write-Host "‚úÖ LGB-Parser dependencies restored"
        } else {
          Write-Host "‚ö†Ô∏è LGB-Parser project file not found"
        }

    - name: Build
      run: dotnet build "$env:Solution_Name" --configuration ${{ matrix.configuration }} --no-restore

    - name: Execute unit tests
      run: dotnet test "$env:Solution_Name" --configuration ${{ matrix.configuration }} --no-build --verbosity normal
      continue-on-error: true

    # Use framework-dependent deployment to avoid system DLL bloat
    - name: Publish Windows x64 (Framework Dependent)
      run: |
        # Framework-dependent deployment - cleaner output
        dotnet publish $env:Project_Path --configuration ${{ matrix.configuration }} --runtime win-x64 --self-contained false --output ./publish/win-x64
        
        Write-Host "üìÇ Framework-dependent publish completed. Contents:"
        Get-ChildItem "./publish/win-x64" | Select-Object Name, Length | Sort-Object Name | Format-Table

    - name: Copy essential external files only
      run: |
        Write-Host "üîß Copying essential files..."
        
        # Verify LGB-Parser.exe is in root (from MSBuild target)
        if (Test-Path "./publish/win-x64/LGB-Parser.exe") {
          Write-Host "‚úÖ LGB-Parser.exe found in root directory"
        } else {
          Write-Host "‚ö†Ô∏è LGB-Parser.exe not in root, searching..."
          
          $lgbParserLocations = @(
            "./bin/${{ matrix.configuration }}/net8.0-windows/LGB-Parser.exe",
            "./LGB-Parser/bin/${{ matrix.configuration }}/net8.0/LGB-Parser.exe"
          )
          
          foreach ($location in $lgbParserLocations) {
            if (Test-Path $location) {
              Copy-Item $location "./publish/win-x64/" -Force
              Write-Host "‚úÖ Copied LGB-Parser.exe from: $location"
              break
            }
          }
        }
        
        # Copy only the SQLite database and essential data files
        if (Test-Path "./Libs") {
          Copy-Item -Path "./Libs" -Destination "./publish/win-x64/" -Recurse -Force
          Write-Host "‚úÖ Copied Libs directory"
          
          if (Test-Path "./publish/win-x64/Libs/app_data.sqlite") {
            $sqliteSize = (Get-Item "./publish/win-x64/Libs/app_data.sqlite").Length
            Write-Host "   ‚úì SQLite database verified ($([math]::Round($sqliteSize/1MB, 2)) MB)"
          }
        }
        
        # Copy Tools directory for unluac.jar
        New-Item -ItemType Directory -Force -Path ./publish/win-x64/Tools
        
        $unluacLocations = @(
          "./bin/${{ matrix.configuration }}/net8.0-windows/Tools/unluac.jar",
          "./Tools/unluac.jar",
          "./unluac/bin/unluac.jar"
        )
        
        foreach ($location in $unluacLocations) {
          if (Test-Path $location) {
            Copy-Item $location "./publish/win-x64/Tools/" -Force
            Write-Host "‚úÖ Copied unluac.jar from: $location"
            break
          }
        }
        
        # Copy all other LGB-Parser dependency DLLs
        Write-Host "üîß Copying LGB-Parser dependencies..."
        
        $lgbDepLocations = @(
          "./bin/${{ matrix.configuration }}/net8.0-windows/",
          "./LGB-Parser/bin/${{ matrix.configuration }}/net8.0/"
        )
        
        foreach ($depDir in $lgbDepLocations) {
          if (Test-Path $depDir) {
            Write-Host "üìÇ Checking dependencies in: $depDir"
            
            # Copy specific LGB-Parser dependencies (INCLUDING LGB-Parser.dll!)
            $lgbDependencies = @(
              "LGB-Parser.dll",                    # ‚Üê ADD THIS! The main LGB-Parser library
              "DotNetZip.dll",
              "EntityFramework.dll", 
              "EntityFramework.SqlServer.dll",
              "Lumina.dll",
              "Microsoft.Extensions.ObjectPool.dll",
              "Newtonsoft.Json.dll"
            )
            
            foreach ($depDll in $lgbDependencies) {
              $sourcePath = Join-Path $depDir $depDll
              $targetPath = "./publish/win-x64/$depDll"
              
              if (Test-Path $sourcePath) {
                if (-not (Test-Path $targetPath)) {
                  Copy-Item $sourcePath $targetPath -Force
                  $size = (Get-Item $sourcePath).Length
                  Write-Host "   ‚úÖ Copied LGB-Parser dependency: $depDll ($([math]::Round($size/1KB, 1)) KB)"
                } else {
                  Write-Host "   ‚úì Dependency already exists: $depDll"
                }
              } else {
                Write-Host "   ‚ö†Ô∏è Missing dependency: $depDll"
              }
            }
            break  # Stop after first successful directory
          }
        }
        
        Write-Host ""
        Write-Host "üìä Final clean structure:"
        Write-Host "Root files:"
        Get-ChildItem "./publish/win-x64" -File | Where-Object { $_.Name -like "*.exe" -or $_.Name -like "*.dll" -or $_.Name -like "*.json" } | Select-Object Name, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB, 1)}} | Sort-Object Name | Format-Table
        
        Write-Host "Directories:"
        Get-ChildItem "./publish/win-x64" -Directory | Select-Object Name | Format-Table
        
        # Count total files
        $totalFiles = (Get-ChildItem "./publish/win-x64" -Recurse -File).Count
        Write-Host "üìà Total files in package: $totalFiles"

    - name: Create Windows ZIP
      run: |
        $version = "v1.0.${{ github.run_number }}"
        Compress-Archive -Path ./publish/win-x64/* -DestinationPath "./Amaurot-Map-Editor-$version-win-x64-debug.zip" -Force
        
        $zipSize = (Get-Item "./Amaurot-Map-Editor-$version-win-x64-debug.zip").Length
        Write-Host "‚úÖ Created clean debug archive: Amaurot-Map-Editor-$version-win-x64-debug.zip ($([math]::Round($zipSize/1MB, 2)) MB)"

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amaurot-Map-Editor-Windows-${{ matrix.configuration }}
        path: ./Amaurot-Map-Editor-*-win-x64-debug.zip

    - name: Upload Windows executables
      uses: actions/upload-artifact@v4
      with:
        name: Amaurot-Map-Editor-Windows-Executable-${{ matrix.configuration }}
        path: ./publish/win-x64/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout (for commit info)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: Amaurot-Map-Editor-Windows-Debug
        path: ./release-assets/

    - name: Generate version number
      id: version
      run: echo "VERSION=v1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT

    - name: Get latest commit info
      id: commit
      run: |
        echo "SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: "Amaurot Quest Editor ${{ steps.version.outputs.VERSION }} (Debug)"
        body: |
          ## Amaurot FFXIV Quest Editor ${{ steps.version.outputs.VERSION }} (Debug Build)
          
          **Auto-generated debug release from commit:** [`${{ steps.commit.outputs.SHORT_SHA }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
          **Latest changes:** ${{ steps.commit.outputs.COMMIT_MESSAGE }}
          
          ### üêõ Debug Framework-Dependent Build
          This is a **DEBUG BUILD** for development and testing purposes:
          - **Requires**: .NET 8.0 Desktop Runtime
          - **Download Runtime**: https://dotnet.microsoft.com/download/dotnet/8.0
          - **Debug Features**: Enhanced logging, debug symbols, unoptimized code
          
          ### üì¶ Package Contents
          - `Amaurot.exe` - Main application (Debug build)
          - `LGB-Parser.exe` - LGB file parser
          - `Libs/` - SQLite database and data files
          - `Definitions/` - FFXIV data definitions  
          - `Tools/unluac.jar` - Lua decompiler
          - Debug symbols and development DLLs
          
          ---
        draft: false
        prerelease: true
        files: |
          ./release-assets/Amaurot-Map-Editor-${{ steps.version.outputs.VERSION }}-win-x64-debug.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}